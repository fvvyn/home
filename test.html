<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fvvyn Bodylinkz Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1e293b; color: white; }
        .card { background-color: #334155; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .highlight { color: #8707ff; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-black mb-6 highlight">Bodylinkz ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card p-5 text-center">
                <p class="text-xs text-gray-400 font-semibold uppercase">ç·è¨ºæ–­ä»¶æ•°</p>
                <p id="total-entries" class="text-4xl font-extrabold highlight mt-1">...</p>
            </div>
            <div class="card p-5 text-center">
                <p class="text-xs text-gray-400 font-semibold uppercase">ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ—¥æ™‚</p>
                <p id="last-updated" class="text-xl font-bold mt-1 text-gray-200">...</p>
            </div>
             <div class="card p-5 text-center">
                <p class="text-xs text-gray-400 font-semibold uppercase">æœ€ã‚‚äººæ°—ãªã‚¢ã‚¤ãƒ†ãƒ </p>
                <p id="most-popular-item" class="text-xl font-bold mt-1 text-gray-200">...</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="card p-5 lg:col-span-2">
                <h2 class="text-xl font-bold mb-4">æ¨å¥¨ã‚µã‚¤ã‚ºåˆ¥ éœ€è¦ã‚°ãƒ©ãƒ• (åœ¨åº«åˆ¤æ–­ã®æ ¹æ‹ )</h2>
                <div class="h-96">
                    <canvas id="sizeChart"></canvas>
                </div>
            </div>

            <div class="card p-5">
                <h2 class="text-xl font-bold mb-4">ãƒ•ã‚£ãƒƒãƒˆæ„Ÿã®å‚¾å‘ (ãƒ‡ã‚¶ã‚¤ãƒ³ã®æ–¹å‘æ€§)</h2>
                 <div class="h-96 flex items-center justify-center">
                    <canvas id="fitChart"></canvas>
                </div>
            </div>
        </div>

        <div id="loading" class="text-center mt-12 text-gray-400">
            <i class="fas fa-spinner fa-spin mr-2"></i> ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...
        </div>
        <div id="error-message" class="hidden text-center mt-12 text-red-400 font-bold">
            ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASã®å®Ÿè¡ŒURLã¾ãŸã¯ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>

    <script>
        // ----------------------------------------------------
        // â–¼â–¼â–¼ ğŸš¨ ã‚ãªãŸã®æä¾›ã—ãŸURLã‚’ã“ã“ã«è¨­å®šã—ã¾ã—ãŸ ğŸš¨ â–¼â–¼â–¼
        const GAS_ADMIN_URL = "https://script.google.com/macros/s/AKfycbwymgN3BB2NcAByg2thxEJrXAf1OJId4c9umZvQgZdFi1p94hVkJGHeJxIb-eEuA_k/exec"; 
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', loadDashboard);

        async function loadDashboard() {
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('error-message');
            loading.classList.remove('hidden');
            errorDiv.classList.add('hidden');

            try {
                const response = await fetch(GAS_ADMIN_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                renderData(data);

            } catch (error) {
                console.error("Failed to load dashboard data:", error);
                errorDiv.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderData(data) {
            // --- ã‚µãƒãƒªãƒ¼ã®æ›´æ–° ---
            document.getElementById('total-entries').textContent = data.totalEntries.toLocaleString();
            document.getElementById('last-updated').textContent = new Date(data.timestamp).toLocaleTimeString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            
            // æœ€ã‚‚äººæ°—ãªã‚¢ã‚¤ãƒ†ãƒ ã®ç‰¹å®š
            const popularItems = Object.entries(data.productPopularity).sort(([,a], [,b]) => b - a);
            document.getElementById('most-popular-item').textContent = popularItems.length > 0 ? popularItems[0][0] : 'N/A';
            
            // --- ã‚°ãƒ©ãƒ•ã®æç”» ---
            
            // 1. æ¨å¥¨ã‚µã‚¤ã‚ºåˆ¥éœ€è¦ã‚°ãƒ©ãƒ• (Bar Chart)
            const sizeLabels = Object.keys(data.sizeDemand);
            const sizeData = Object.values(data.sizeDemand);
            const sizeCtx = document.getElementById('sizeChart').getContext('2d');
            
            new Chart(sizeCtx, {
                type: 'bar',
                data: {
                    labels: sizeLabels,
                    datasets: [{
                        label: 'æ¨å¥¨ä»¶æ•°',
                        data: sizeData,
                        backgroundColor: '#8707ff',
                        borderColor: '#8707ff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // 2. ãƒ•ã‚£ãƒƒãƒˆæ„Ÿã®å‚¾å‘ã‚°ãƒ©ãƒ• (Doughnut Chart)
            const fitLabels = Object.keys(data.fitPreference);
            const fitData = Object.values(data.fitPreference);
            const fitCtx = document.getElementById('fitChart').getContext('2d');
            
            new Chart(fitCtx, {
                type: 'doughnut',
                data: {
                    labels: fitLabels,
                    datasets: [{
                        data: fitData,
                        backgroundColor: ['#8707ff', '#3b82f6', '#ef4444', '#f59e0b'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right', labels: { color: 'white' } } ,
                        tooltip: { callbacks: { label: (context) => {
                            let label = context.label || '';
                            if (label) label += ': ';
                            if (context.parsed !== null) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1) + '%';
                                label += percentage + ' (' + context.parsed.toLocaleString() + 'ä»¶)';
                            }
                            return label;
                        }}}
                    }
                }
            });
        }
    </script>
</body>
</html>
