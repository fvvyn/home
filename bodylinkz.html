<!DOCTYPE html>
<html lang="ja">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MF598BWN4M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-MF598BWN4M');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <title>fvvyn | Bodylinkz サイズ提案システム - 最適なサイズをご提案</title>
  <meta name="description" content="fvvynによるBodylinkz独自のAIが、身長・体重・フィット感から理想のサイズをパーソナライズ診断。失敗しないサイズ選びを体験しましょう。" />
  <link rel="canonical" href="https://fvvyn.com/bodylinkz/size-recommender" /> 
  <meta property="og:title" content="fvvyn| Bodylinkz サイズ提案システム" />
  <meta property="og:description" content="理想のサイズをAIが提案。fvvynアイテムのサイズ不安を解消しましょう。" />
  <meta property="og:url" content="https://fvvyn.com/bodylinkz/size-recommender" /> 
  <meta property="og:site_name" content="fvvyn©︎公式 | Bodylinkz" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://fvvyn.com/images/bodylinkz-ogp.jpg" /> 
  <meta name="twitter:card" content="summary_large_image" /> 
  <meta name="twitter:creator" content="@fvvyn_official" />
  <meta name="robots" content="index, follow">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script> 

  <style>
    :root {
      --primary: #8707ff;
      --primary-dark: #6a00cd;
      --bg-color: #f8fafc;
      --text-main: #1e293b;
    }

    body { 
        font-family: 'Inter', sans-serif; 
        background-color: var(--bg-color); 
        color: var(--text-main); 
    }

    /* Result View Fixes */
    #result-view {
        width: 100% !important;
        padding-left: 16px !important;
        padding-right: 16px !important;
        padding-top: 10px !important;
        box-sizing: border-box !important;
        scroll-behavior: smooth;
        overflow-y: auto;
        padding-bottom: 100px !important;
    }

    #canvas-container {
        width: 100% !important;
        height: 350px !important;
        min-height: 350px !important; 
        position: relative !important;
        background: radial-gradient(circle at center, #ffffff 0%, #f1f5f9 100%) !important;
        border-radius: 20px !important;
        overflow: hidden !important;
        margin-bottom: 30px !important;
        border: 1px solid #d1d5db !important;
        box-sizing: border-box !important;
    }

    @media (max-height: 700px) {
        #canvas-container {
            height: 300px !important;
            min-height: 300px !important;
        }
    }
    @media (min-width: 768px) {
        #canvas-container {
            height: 450px !important;
        }
    }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }

    /* UI Components */
    .card-select {
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      border: 2px solid transparent;
    }
    .card-select:active { transform: scale(0.98); }
    .card-select.selected {
      border-color: var(--primary);
      background-color: #f3e8ff;
      color: var(--primary-dark);
      box-shadow: 0 4px 12px rgba(135, 7, 255, 0.15);
    }
    
    /* Range Slider */
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 24px; width: 24px;
      border-radius: 50%; background: var(--primary);
      cursor: pointer; margin-top: -10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); border: 2px solid white;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 6px; cursor: pointer;
      background: #e2e8f0; border-radius: 3px;
    }
    
    /* 3D Annotations */
/* アノテーション（ピン）のベーススタイル */
.annotation {
    position: absolute;
    width: 75px;               /* 幅を固定で統一 */
    height: 48px;              /* 高さを固定で統一 */
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #e2e8f0;
    border-radius: 9px;
    display: flex;
    flex-direction: column;    /* 縦に並べる */
    align-items: center;       /* 左右中央揃え */
    justify-content: center;   /* 上下中央揃え */
    pointer-events: none;
    z-index: 20;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: opacity 0.3s;
    transform: translate(-50%, -50%); /* 座標の基準をピンの中心にする */
}

/* ラベル（WAISTなど）のスタイル */
.annotation .label {
    font-size: 7px;
    color: #94a3b8;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.05em;
    margin-bottom: 2px;
}

/* 数値とフィット感のコンテナ */
.annotation .status-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    line-height: 1.1;
}
.annotation .value-text {
    color: #868686; /* ここに好きな色を指定 */
    font-size: 11px;
    font-weight: 400;
}
/* フィット感テキストの個別色設定 */
.status-tight { color: #ef4444; font-weight: bold; } /* 赤系 */
.status-just  { color: #10b981; font-weight: bold; } /* 緑系 */
.status-loose { color: #3b82f6; font-weight: bold; } /* 青系 */
    /* Loader */
    .loader {
      border: 3px solid #f3f3f3; border-top: 3px solid var(--primary);
      border-radius: 50%; width: 30px; height: 30px;
      animation: spin 1s linear infinite; margin: 0 auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Glass Panel */
    .glass-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    /* Toast */
    .toast {
      visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff;
      text-align: center; border-radius: 50px; padding: 12px 24px;
      position: fixed; z-index: 60; left: 50%; bottom: 30px;
      transform: translateX(-50%); font-size: 14px; font-weight: 500;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .toast.show { visibility: visible; animation: slideUpFade 0.5s, fadeOut 0.5s 2.5s forwards; }
    @keyframes slideUpFade { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    @keyframes fadeOut { from {opacity: 1;} to {opacity: 0;} }

    /* Animations */
    @keyframes bounce {
      0%, 100% { transform: translateY(0) translateX(-50%); }
      50% { transform: translateY(10px) translateX(-50%); }
    }
    .animate-bounce {
      animation: bounce 2s infinite;
    }

    /* Fit Indicator */
    .px-6.mb-6 > .bg-slate-50 {
        background-color: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding-top: 0 !important;
    }
    #fit-indicator-bar {
        background-color: rgba(197, 142, 248, 0.8) !important; 
    }

/* 使い方ガイド用スタイル (4ステップ) */
    .guide-container {
      padding: 0 16px 16px 16px;
      margin-top: -4px;
    }
    .guide-card {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid #f1f5f9;
      border-radius: 16px;
      padding: 10px 4px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.04);
    }
    .guide-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      flex: 1;
    }
    .guide-step-num {
      width: 20px;
      height: 20px;
      background: #f1f5f9; /* 未達成ステップの色 */
      color: #94a3b8;
      font-size: 10px;
      font-weight: 900;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    /* アクティブ（紫）の状態 */
    .guide-item.completed .guide-step-num {
      background: var(--primary);
      color: white;
    }
    .guide-text {
      font-size: 7.5px;
      font-weight: 700;
      color: #94a3b8;
      letter-spacing: -0.02em;
      white-space: nowrap;
    }
    .guide-item.completed .guide-text {
      color: var(--text-main);
    }
    .guide-arrow {
      font-size: 7px;
      color: #e2e8f0;
    }

    /* 商品画像：円を削除し拡大 */
    .product-img-wrapper {
      width: 100px; /* サイズを大きく */
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .product-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

/* 選択されたカードの紫枠 */
    .card-select.selected {
      border: 2px solid #8707ff !important;
      background-color: #f5f3ff;
    }

    /* ボタンの表示・非表示アニメーション */
    .next-btn-hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    .next-btn-visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
      transition: all 0.3s ease;
    }
    /* Scroll to 3D Btn */
    .scroll-to-3d-btn {
        position: fixed;
        right: 20px;
        bottom: 100px;
        width: 60px;
        height: 60px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 900;
        box-shadow: 0 4px 15px rgba(135, 7, 255, 0.4);
        cursor: pointer;
        z-index: 40;
        transition: all 0.3s ease;
        border: 2px solid white;
        line-height: 1.2;
    }

    /* ガイドポップアップのアニメーション */
@keyframes modalFadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
.modal-animate { animation: modalFadeIn 0.3s ease-out forwards; }

/* 左下の？ボタンのふわふわアニメーション */
@keyframes pulse-slow {
  0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(135, 7, 255, 0.2); }
  50% { transform: scale(1.05); box-shadow: 0 4px 20px rgba(135, 7, 255, 0.4); }
}
.btn-pulse { animation: pulse-slow 3s infinite ease-in-out; }

/* ガイド用ステップ図解 */
.guide-step-box {
  transition: all 0.3s ease;
  border-left: 3px solid #e2e8f0;
}
.guide-step-box:hover {
  border-left-color: #8707ff;
  background: #fdfcff;
}
    .scroll-to-3d-btn:active { transform: scale(0.9); }
    .scroll-to-3d-btn i { font-size: 16px; margin-bottom: 2px; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-0 md:p-4 bg-slate-50">

  <div class="w-full md:max-w-md h-screen md:h-auto glass-panel md:shadow-2xl md:rounded-[32px] overflow-hidden relative flex flex-col bg-white">
    
    <div class="absolute top-0 left-0 w-full h-1 bg-gray-100 z-20">
      <div id="progress-bar" class="h-full bg-[#8707ff] transition-all duration-500 ease-out" style="width: 25%"></div>
    </div>

    <header class="pt-6 px-6 pb-2 text-center flex-shrink-0 z-10 bg-white md:bg-transparent">
      <h1 class="text-xl font-black tracking-tight text-slate-800">fvvyn <span class="text-[#8707ff] font-light">Bodylinkz</span></h1>
      <p class="text-[10px] text-gray-400 mt-1 tracking-widest uppercase font-medium" id="step-indicator">Step 1 / 4</p>
    </header>

    <div class="guide-container">
      <div class="guide-card" id="main-guide">
        <div class="guide-item completed" data-gstep="1">
          <span class="guide-step-num">1</span>
          <span class="guide-text">アイテム選択</span>
        </div>
        <i class="fa-solid fa-chevron-right guide-arrow"></i>
        <div class="guide-item" data-gstep="2">
          <span class="guide-step-num">2</span>
          <span class="guide-text">理想のフィット感</span>
        </div>
        <i class="fa-solid fa-chevron-right guide-arrow"></i>
        <div class="guide-item" data-gstep="3">
          <span class="guide-step-num">3</span>
          <span class="guide-text">体重身長を入力</span>
        </div>
        <i class="fa-solid fa-chevron-right guide-arrow"></i>
        <div class="guide-item" data-gstep="4">
          <span class="guide-step-num">4</span>
          <span class="guide-text">サイズ算出</span>
        </div>
      </div>
    </div>

    <div id="step-container" class="relative flex-1 overflow-hidden">
      <div data-step="1" class="step-content fade-in h-full flex flex-col p-6 overflow-y-auto">
        <h2 class="text-lg font-bold text-slate-700 mb-4 text-center">どのアイテムをお探しですか？</h2>
        <div class="grid grid-cols-2 gap-3 flex-1 content-start" id="product-grid">
          
          <!-- <div class="card-select bg-slate-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-1 h-44" onclick="selectProduct('slash-tshirt', this)">
            <div class="product-img-wrapper">
              <img src="https://via.placeholder.com/200/FFFFFF/8707ff?text=Slash" class="product-img">
            </div>
            <span class="text-xs font-bold text-center">Slash Tshirts</span>
          </div>-->
          
         <!-- <div class="card-select bg-slate-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-1 h-44" onclick="selectProduct('logo-tshirt', this)">
            <div class="product-img-wrapper">
              <img src="https://via.placeholder.com/200/FFFFFF/8707ff?text=Logo" class="product-img">
            </div>
            <span class="text-xs font-bold text-center">Logo Tshirts</span>
           </div> -->
          
          <!-- <div class="card-select bg-slate-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-1 h-44" onclick="selectProduct('lamp-zip-hoodie', this)">
            <div class="product-img-wrapper">
              <img src="https://via.placeholder.com/200/FFFFFF/8707ff?text=Lamp" class="product-img">
            </div>
            <span class="text-xs font-bold text-center">Lamp Zip Hoodie</span>
          </div>-->
          
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-1 h-44" onclick="selectProduct('cloudy-zip-hoodie', this)">
             <div class="product-img-wrapper">
               <img src="https://imagedelivery.net/QondspN4HIUvB_R16-ddAQ/67dd6b6ac7a8724e2295d4ff/ec49c656f8c2e44d3393.png/fit=cover,w=920,h=920" class="product-img">
             </div>
             <span class="text-xs font-bold text-center">CLOUD ZIP HOODIE</span>
          </div>

          <div class="card-select bg-slate-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-1 h-44" onclick="selectProduct('cloud-pants', this)">
            <div class="product-img-wrapper">
              <img src="https://imagedelivery.net/QondspN4HIUvB_R16-ddAQ/67dd6b6ac7a8724e2295d4ff/815577f9f2e2b5686be9.png/fit=cover,w=920,h=920" class="product-img">
            </div>
            <span class="text-xs font-bold text-center">Cloud pants</span>
          </div>
        </div>
        <input type="hidden" id="product">
      </div>



      <div data-step="2" class="step-content hidden fade-in h-full flex flex-col p-6">
        <h2 class="text-lg font-bold text-slate-700 mb-4 text-center">好みのフィット感を選択してください</h2>
        <div class="flex flex-col gap-3" id="fit-grid">
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex items-center gap-4" onclick="selectFit('slim', this)">
            <div class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400"><i class="fa-solid fa-child-reaching"></i></div>
            <div class="text-left">
              <p class="font-bold text-sm text-slate-800">Slim Fit</p>
              <p class="text-[11px] text-gray-500 mt-0.5">タイトめ / すっきり</p>
            </div>
          </div>
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex items-center gap-4" onclick="selectFit('standard', this)">
            <div class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400"><i class="fa-solid fa-child"></i></div>
            <div class="text-left">
              <p class="font-bold text-sm text-slate-800">Standard Fit</p>
              <p class="text-[11px] text-gray-500 mt-0.5">標準 / ジャストサイズ</p>
            </div>
          </div>
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex items-center gap-4" onclick="selectFit('oversized', this)">
            <div class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400"><i class="fa-solid fa-person-rays"></i></div>
            <div class="text-left">
              <p class="font-bold text-sm text-slate-800">Oversized</p>
              <p class="text-[11px] text-gray-500 mt-0.5">ゆったり / ストリート</p>
            </div>
          </div>
        </div>
        <input type="hidden" id="fit">
      </div>

      <div data-step="3" class="step-content hidden fade-in h-full flex flex-col p-6">
        <h2 class="text-lg font-bold text-slate-700 mb-8 text-center">あなたの体型について</h2>
        
        <div class="mb-10 bg-slate-50 p-6 rounded-3xl">
          <div class="flex justify-between items-end mb-6">
            <label class="text-sm font-bold text-gray-500 flex items-center gap-2"><i class="fa-solid fa-ruler-vertical"></i> 身長</label>
           <span class="text-3xl font-black text-[#8707ff]">
  <span id="height-val">170</span> <span class="text-sm text-gray-400 font-medium">cm</span>
  <span id="height-imperial" class="text-xs text-gray-400 font-medium ml-1">(5'7")</span>
</span>
          </div>
         <input type="range" min="140" max="210" value="170" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#8707ff]" oninput="syncInput('height', this.value)">

<div id="step3-error-msg" class="hidden text-red-500 text-xs text-center mt-4 font-bold">
    ご自身の数値を入力してください
</div>
          <div class="flex justify-between text-[10px] text-gray-400 mt-2 font-medium tracking-wide">
              <span>140cm</span>
              <span>210cm</span>
          </div>
          <input type="number" id="height" class="hidden" value="170"> 
        </div>

        <div class="mb-4 bg-slate-50 p-6 rounded-3xl">
          <div class="flex justify-between items-end mb-6">
            <label class="text-sm font-bold text-gray-500 flex items-center gap-2"><i class="fa-solid fa-weight-scale"></i> 体重</label>
            <span class="text-3xl font-black text-[#8707ff]"><span id="weight-val">60</span> <span class="text-sm text-gray-400 font-medium">kg</span></span>
          </div>
          <input type="range" id="weight-range" min="30" max="130" value="60" class="w-full accent-[#8707ff]" oninput="syncInput('weight', this.value)">
           <div class="flex justify-between text-[10px] text-gray-400 mt-2 font-medium tracking-wide">
              <span>30kg</span>
              <span>130kg</span>
          </div>
          <input type="number" id="weight" class="hidden" value="60"> 
        </div>
      </div>

      <div data-step="4" class="step-content hidden h-full flex flex-col relative">
        
        <div id="loading-view" class="absolute inset-0 bg-white z-20 flex flex-col items-center justify-center hidden">
          <div class="loader mb-4"></div>
          <p class="text-xs text-gray-500 font-medium tracking-widest animate-pulse">AI Analyzing...</p>
        </div>

        <div id="result-view" class="flex-1 flex flex-col h-full overflow-y-auto bg-white fade-in">
          
          <div class="px-6 pt-6 pb-4 text-center">
            <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-1">Recommended Size</p>
            <div class="flex items-baseline justify-center gap-2">
                <span id="recommended-size" class="text-5xl font-black text-[#8707ff]">L</span>
                <span class="text-sm text-gray-500 font-medium">がおすすめです</span>
            </div>
            <p id="product-name-display" class="text-xs text-gray-400 mt-1">Product Name</p>
          </div>

          <div class="px-6 mb-6">
            <div class="bg-slate-50 rounded-2xl p-5 border border-slate-100">
              <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-4 text-center">Fit Analysis</p>
              <div id="fit-indicator-bar" class="relative w-full h-2 bg-gray-200 rounded-full mb-6">
                <div class="absolute w-full flex justify-between -top-1 px-1">
                  <span class="w-1 h-4 bg-white border border-gray-200 rounded-full"></span>
                  <span class="w-1 h-4 bg-white border border-gray-200 rounded-full"></span>
                  <span class="w-1 h-4 bg-white border border-gray-200 rounded-full"></span>
                </div>
                <div id="fit-pin" class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 transition-all duration-1000 ease-out" style="left: 50%;">
                  <div class="w-4 h-4 bg-[#8707ff] rounded-full border-2 border-white shadow-md"></div>
                  <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 text-[10px] font-bold whitespace-nowrap text-[#8707ff]" id="fit-label">
                    Standard
                  </div>
                </div>
              </div>
              <div class="flex justify-between text-[9px] text-gray-400 font-bold uppercase tracking-tighter">
                <span>Tight</span>
                <span>Optimal</span>
                <span>Loose</span>
              </div>
            </div>
          </div>

          <div class="px-7 mt-0.5 mb-3.5">
              <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                  <i class="fa-solid fa-person-half-dress text-[#8707ff]"></i>　3Dフィッティング・プレビュー
              </h3>
              <p class="text-[11px] text-gray-500 mt-1 leading-relaxed">
                  AIが算出した体型データを元に、推奨サイズの着用感をシミュレートしています。肩幅・身幅・袖丈のゆとりを確認してください。
              </p>
          </div>

          <div id="canvas-container" class="relative">
              </div>

          <div class="px-6 mt-6 pb-4">
            <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-chart-simple text-[#8707ff]"></i> サイズ詳細 (cm)
            </h3>
            <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 mb-2"> 
                <ul id="size-spec" class="grid grid-cols-2 gap-y-3 text-sm text-gray-600">
                </ul>
            </div>

            <div class="py-4 px-5 -mx-2 mt-3 bg-purple-50 rounded-xl border border-purple-100 text-xs text-purple-800 leading-relaxed shadow-sm">
                <i class="fa-solid fa-circle-info mr-2"></i>
                <span id="result-message">メッセージ</span>
            </div>
          </div>

          <div id="move-to-3d" class="scroll-to-3d-btn hidden" onclick="scrollTo3D()">
            <i class="fa-solid fa-cube"></i>
            <span>3D↓</span>
          </div>

          <div class="pt-10 pb-1 text-center">
              <p class="text-[10px] text-gray-400 font-medium tracking-tight">
                  &copy; 2025 fvvyn. All Rights Reserved.
              </p>
              <p class="text-[9px] text-gray-300 mt-1">
                  この技術はfvvynによって保護されています
              </p>
          </div>
          
          <div class="h-24"></div>
        </div>

        <div class="absolute bottom-0 left-0 w-full p-4 bg-white/90 backdrop-blur-md border-t border-gray-100 flex gap-3 z-30">
            <button onclick="resetForm()" class="px-6 py-3 rounded-full border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50">
                Retake
            </button>
            <a href="https://fvvyn.stores.jp/" target="_blank" class="flex-1 bg-[#1e293b] text-white flex items-center justify-center gap-2 py-3 rounded-full font-bold text-sm shadow-lg hover:bg-black transition-all">
                Buy this size <i class="fa-solid fa-arrow-right"></i>
            </a>
        </div>
      </div>

    </div>

  <div id="nav-controls" class="p-6 bg-white flex flex-col gap-3 flex-shrink-0 z-10">
  <div class="w-full text-center mb-1">
      <p class="text-[10px] text-gray-400 font-medium tracking-tight">
          &copy; 2025 fvvyn All Rights Reserved.
      </p>
      <p class="text-[9px] text-gray-300">
          この技術はfvvyn©により保護されています
      </p>
  </div>
  
  <div class="flex gap-3">
      <button id="back-button" class="flex-1 py-3 rounded-full border border-gray-200 text-gray-500 font-bold text-sm hover:bg-gray-50 transition-colors hidden focus:outline-none">戻る</button>
      <button id="next-button" class="flex-1 py-3 rounded-full bg-[#8707ff] text-white font-bold text-sm shadow-lg shadow-purple-200 hover:bg-[#6a00cd] transition-all active:scale-95">次へ</button>
  </div>
</div>

  <div id="toast" class="toast">Message Here</div>

  <div id="email-popup" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closePopup()"></div>
    
    <div class="bg-white rounded-[32px] p-8 w-full max-w-sm shadow-2xl transform transition-all scale-100 relative z-10 text-center border border-gray-100">
      
      <button onclick="closePopup()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-100 text-gray-400 hover:bg-gray-200 flex items-center justify-center transition-colors">
        <i class="fa-solid fa-xmark"></i>
      </button>

      <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4 text-[#8707ff] text-2xl">
        <i class="fa-solid fa-envelope-open-text"></i>
      </div>

      <h3 class="text-xl font-black text-slate-800 mb-2">UNLOCK 10% OFF</h3>
      <p class="text-xs text-gray-500 leading-relaxed mb-6">
        サイズ診断結果はいかがでしたか？<br>
        メールアドレス登録で、今回のお買い物から使える<br>
        <strong>限定クーポンコード</strong>をお届けします。
      </p>

      <form onsubmit="handleEmailSubmit(event)" class="space-y-4">
        <input type="email" id="email-input" placeholder="example@email.com" required 
          class="w-full px-5 py-3 rounded-xl bg-slate-50 border border-gray-200 text-sm focus:outline-none focus:border-[#8707ff] focus:ring-2 focus:ring-purple-100 transition-all placeholder:text-gray-300">
        
        <div class="flex items-start gap-3 text-left px-1">
          <input type="checkbox" id="consent-check" required class="mt-1 w-4 h-4 accent-[#8707ff] cursor-pointer">
          <label for="consent-check" class="text-[10px] text-gray-400 leading-tight cursor-pointer">
            <a href="#" class="underline hover:text-gray-600">プライバシーポリシー</a>および<br>
            <a href="#" class="underline hover:text-gray-600">利用規約</a>に同意して登録します。
          </label>
        </div>

        <button type="submit" id="email-submit-btn" class="w-full py-3.5 rounded-full bg-[#8707ff] text-white font-bold text-sm shadow-lg shadow-purple-200 hover:bg-[#6a00cd] hover:shadow-purple-300 transition-all active:scale-95">
          クーポンを受け取る
        </button>
      </form>
      
      <button onclick="closePopup()" class="text-[10px] text-gray-400 mt-4 underline hover:text-gray-600">
        登録せずに閉じる
      </button>
    </div>
  </div>

  <script>
    // --- GAS Settings ---
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwQ5ty0nbI1-dDl1-BsFGp0Xxg5XJ8xnpIn3vv2qN440Wgtt3bUfPUeoG-Bh--Vw6wt/exec";

    // --- Data Definition ---
    const PRODUCT_SIZES = {
      'slash-tshirt': {
        name: "Slash Tshirts",
        S: { height:[150,160], weight:[40,55], length:66, chest:98, shoulder:44, sleeve:19 },
        M: { height:[160,170], weight:[50,65], length:70, chest:104, shoulder:47, sleeve:20 },
        L: { height:[170,180], weight:[60,75], length:74, chest:110, shoulder:50, sleeve:22 },
        XL: { height:[180,190], weight:[70,85], length:78, chest:116, shoulder:53, sleeve:24 },
        XXL: { height:[185,195], weight:[80,95], length:82, chest:122, shoulder:56, sleeve:26 },
        XXXL: { height:[190,200], weight:[90,105], length:84, chest:128, shoulder:59, sleeve:26 }
      },
      'logo-tshirt': {
        name: "Logo Tshirts",
        S: { height:[150,160], weight:[40,55], length:66, chest:98, shoulder:44, sleeve:19 },
        M: { height:[160,170], weight:[50,65], length:70, chest:104, shoulder:47, sleeve:20 },
        L: { height:[170,180], weight:[60,75], length:74, chest:110, shoulder:50, sleeve:22 },
        XL: { height:[180,190], weight:[70,85], length:78, chest:116, shoulder:53, sleeve:24 },
        XXL: { height:[185,195], weight:[80,95], length:82, chest:122, shoulder:56, sleeve:26 },
        XXXL: { height:[190,200], weight:[90,105], length:84, chest:128, shoulder:59, sleeve:26 }
      },
      'beg-zip-hoodie': {
        name: "Beg Zip Hoodie",
        S: { height:[155,165], weight:[45,60], length:55, chest:102, shoulder:60, sleeve:56.5 },
        M: { height:[165,175], weight:[55,70], length:57.5, chest:107, shoulder:62.5, sleeve:59 },
        L: { height:[175,185], weight:[65,80], length:60, chest:112, shoulder:65, sleeve:61.5 }
      },
      'lamp-zip-hoodie': {
        name: "Lamp Zip Hoodie",
        XS: { height:[150,160], weight:[40,55], length:52.5, chest:91, shoulder:70, sleeve:51 },
        S: { height:[160,170], weight:[50,65], length:55.5, chest:94, shoulder:72, sleeve:52 },
        M: { height:[170,180], weight:[60,75], length:58.5, chest:97, shoulder:74, sleeve:53 },
        L: { height:[180,190], weight:[70,85], length:61.5, chest:100, shoulder:76, sleeve:54 },
        XL: { height:[185,195], weight:[80,95], length:64.5, chest:103, shoulder:78, sleeve:55 }
      },
      'cloudy-zip-hoodie': {
        name: "CLOUDY ZIP HOODIE",
        XS: { height:[145,155], weight:[35,45], length:53.0, chest:97, shoulder:57.5, sleeve:54.0 }, 
        S: { height:[155,165], weight:[45,55], length:55.5, chest:102, shoulder:60.0, sleeve:56.5 },
        M: { height:[165,175], weight:[55,65], length:58.0, chest:107, shoulder:62.5, sleeve:59.0 },
        L: { height:[175,185], weight:[65,75], length:60.5, chest:112, shoulder:65.0, sleeve:61.5 }
      },
    
        'cloud-pants': {
    name: "Cloud pants",
    XS: { height:[150,160], weight:[45,55], waist:65, length:100, inseam:73 },
    S:  { height:[160,170], weight:[50,60], waist:70, length:103, inseam:75 },
    M:  { height:[170,180], weight:[60,75], waist:75, length:106, inseam:77 },
    L:  { height:[180,190], weight:[70,85], waist:80, length:109, inseam:79 },
    XL: { height:[185,195], weight:[80,95], waist:85, length:112, inseam:81 }
  }
};
      
 

    const FIT_PRESETS = {
        'slim': { offset: -1, text: 'タイトなシルエットをご提案します。' },
        'standard': { offset: 0, text: 'スタンダードなサイズ感です。' },
        'oversized': { offset: 1, text: 'ゆとりあるサイズをご提案します。' }
    };

// 修正後
// --- State Management ---
const state = {
    step: 1,
    product: null,
    fit: null,
    height: 170,
    weight: 60,
    heightTouched: false, // 追加：身長を操作したか
    weightTouched: false  // 追加：体重を操作したか
};

    // --- UI Logic ---
    const steps = document.querySelectorAll('.step-content');
    const nextBtn = document.getElementById('next-button');
    const backBtn = document.getElementById('back-button');
    const navControls = document.getElementById('nav-controls');
    const progressBar = document.getElementById('progress-bar');
    const stepIndicator = document.getElementById('step-indicator');

    function updateUI(step) {
      state.step = step;
      steps.forEach(s => {
        s.classList.add('hidden');
        s.classList.remove('fade-in');
      });
      
      const targetStep = document.querySelector(`[data-step="${step}"]`);
      targetStep.classList.remove('hidden');
      void targetStep.offsetWidth; // Trigger reflow
      targetStep.classList.add('fade-in');

      const percentage = (step / 4) * 100;
      progressBar.style.width = percentage + '%';
      
      stepIndicator.textContent = step === 4 ? "RESULT" : `Step ${step} / 3`;

      backBtn.classList.toggle('hidden', step === 1);
      
      if (step === 4) {
        navControls.classList.add('hidden');
      } else {
        navControls.classList.remove('hidden');
      }
    }

    nextBtn.onclick = () => {
      if (!validateStep()) return;
      if (state.step < 3) {
        updateUI(state.step + 1);
      } else {
        calculateAndShowResult();
      }
    };

    backBtn.onclick = () => {
        if (state.step > 1) {
            if (state.step === 4) {
                cleanup3DScene();
            }
            updateUI(state.step - 1);
        }
    };
function validateStep() {
    const errorMsg = document.getElementById('step3-error-msg');
    
    if (state.step === 1 && !state.product) { showToast('アイテムを選択してください'); return false; }
    if (state.step === 2 && !state.fit) { showToast('フィット感を選択してください'); return false; }
    
    if (state.step === 3) {
        // 未操作（身長か体重のどちらかが一度も動かされていない）
        if (!state.heightTouched || !state.weightTouched) {
            errorMsg.classList.remove('hidden'); // メッセージを表示
            showToast('ご自身の数値を入力してください');
            return false;
        }
        
        // 異常値チェック（前の条件も維持）
        if (state.height < 145 || state.height > 205 || state.weight < 35 || state.weight > 125) {
            errorMsg.textContent = '正しい値を入力してください'; // 文言を切り替え
            errorMsg.classList.remove('hidden');
            showToast('正しい値を入力してください');
            return false;
        }
    }
    
    // エラーがなければ隠す
    if (errorMsg) errorMsg.classList.add('hidden');
    return true;
}

function selectProduct(product, element) {
    state.product = product;
    document.getElementById('product').value = product;

    // 1. すべてのカードから選択状態（selectedクラス）を消す
    document.querySelectorAll('#product-grid .card-select').forEach(card => {
        card.classList.remove('selected');
    });
    
    // 2. クリックしたカードだけに紫の枠（selectedクラス）を付ける
    element.classList.add('selected');

    // 3. 「次へ進む」ボタンをふわっと表示させる
    const nextBtn1 = document.getElementById('next-btn-step1');
    if (nextBtn1) {
        nextBtn1.classList.remove('opacity-0', 'pointer-events-none');
        nextBtn1.classList.add('opacity-100', 'pointer-events-auto');
        // 少し上に浮き上がるアニメーションを加える場合（CSSに合わせて）
        nextBtn1.style.transform = "translateY(0)";
    }
    
    // 【修正】ここにあった nextStep(); を削除しました
}

    window.selectFit = (id, el) => {
      state.fit = id;
      document.querySelectorAll('#fit-grid .card-select').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
       setTimeout(() => nextBtn.click(), 300);
    };

window.syncInput = (key, val) => {
    const value = parseInt(val);
    state[key] = value;
    document.getElementById(`${key}-val`).textContent = val;
    
    state[`${key}Touched`] = true;

    // ↓ここを追加：操作されたらエラー文を隠す
    const errorMsg = document.getElementById('step3-error-msg');
    if (state.heightTouched && state.weightTouched) {
        if (errorMsg) errorMsg.classList.add('hidden');
    }

    if (key === 'height') {
        const totalInches = value / 2.54;
        const feet = Math.floor(totalInches / 12);
        const inches = Math.round(totalInches % 12);
        document.getElementById('height-imperial').textContent = `(${feet}'${inches}")`;
    }
};

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.className = "toast show";
        setTimeout(() => t.className = "toast", 3000);
    }

    window.resetForm = () => {
        state.product = null; state.fit = null; state.step = 1;
        document.querySelectorAll('.card-select').forEach(c => c.classList.remove('selected'));
        cleanup3DScene();
        updateUI(1);
    }

    function sendDataToGAS(data) {
        fetch(GAS_API_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(() => {
            console.log("Data sent to spreadsheet.");
        })
        .catch(error => {
            console.error("Error sending data:", error);
        });
    }

    // --- Core Calculation & 3D Logic ---

function calculateAndShowResult() {
    const loading = document.getElementById('loading-view');
    updateUI(4);
    loading.classList.remove('hidden');

    setTimeout(() => {
        const result = performCalculation();
        // renderResult(result); // ← ここでエラーが出ていたので削除
        init3DScene(result);
        
        const trackingData = {
            type: 'tracking',
            productId: state.product,
            productName: result.productName,
            height: state.height,
            weight: state.weight,
            fitPreference: state.fit,
            recommendedSize: result.recSize
        };
        sendDataToGAS(trackingData);

        loading.classList.add('hidden');
        
        setTimeout(() => {
            const hasRegistered = localStorage.getItem('fvvyn_email_registered');
            if (!hasRegistered) {
                document.getElementById('email-popup').classList.remove('hidden');
                document.getElementById('email-popup').classList.add('fade-in');
            }
        }, 3500);

    }, 1500);

    
}

function performCalculation() {
    const data = PRODUCT_SIZES[state.product];
    const adjustment = FIT_PRESETS[state.fit];
    const h = state.height;
    const w = state.weight;
    const sizeKeys = Object.keys(data).filter(k => k !== 'name');

    let bestDist = Infinity;
    let baseIdx = 0;

    sizeKeys.forEach((size, idx) => {
        const sData = data[size];
        const avgH = (sData.height[0] + sData.height[1]) / 2;
        const avgW = (sData.weight[0] + sData.weight[1]) / 2;
        const dist = Math.abs(h - avgH) + (Math.abs(w - avgW) * 2.0);
        if (dist < bestDist) { bestDist = dist; baseIdx = idx; }
    });

    let finalIdx = baseIdx + adjustment.offset;
    finalIdx = Math.max(0, Math.min(finalIdx, sizeKeys.length - 1));
    const recSize = sizeKeys[finalIdx];
    const prod = data[recSize];

    // 体型推定
    const est = {
        shoulder: (h * 0.23) + (w * 0.1),
        chest: (h * 0.48) + (w * 0.25),
        sleeve: (h * 0.35) + (w * 0.05),
        waist: (w * 1.2), // 簡易計算
        length: (h * 0.55),
        inseam: (h * 0.42)
    };

    const analyze = (body, garment, type) => {
        let diff = garment - body;
        // アイテム特性に合わせた閾値設定
        const looseThreshold = state.product.includes('hoodie') || state.product.includes('pants') ? 12 : 8;
        const tightThreshold = state.product.includes('hoodie') || state.product.includes('pants') ? 5 : 3;
        
        if (diff < tightThreshold) return { status: 'Tight', class: 'status-tight', text: 'タイト' };
        if (diff > looseThreshold) return { status: 'Loose', class: 'status-loose', text: 'ゆったり' };
        return { status: 'Just Right', class: 'status-just', text: '標準' };
    };

    // 全てのキーに対して解析を実行
    const analysis = {};
    Object.keys(est).forEach(key => {
        if (prod[key]) {
            analysis[key] = analyze(est[key], prod[key], key);
        }
    });

    return {
        recSize,
        productName: data.name,
        spec: prod,
        analysis: analysis,
        message: adjustment.text
    };
}

function renderResult(res) {
    const recSizeEl = document.getElementById('recommended-size');
    const prodNameEl = document.getElementById('product-name-display');
    const msgEl = document.getElementById('result-message');
    const specList = document.getElementById('size-spec');

    if (recSizeEl) recSizeEl.textContent = res.recSize;
    if (prodNameEl) prodNameEl.textContent = res.productName;
    if (msgEl) msgEl.textContent = res.message;

    const isPants = state.product === 'cloud-pants';

    // スペックリスト（表）の更新
    if (specList) {
        const specs = isPants ? 
            [['ウエスト', 'waist'], ['総丈', 'length'], ['股下', 'inseam']] : 
            [['着丈', 'length'], ['身幅', 'chest'], ['肩幅', 'shoulder'], ['袖丈', 'sleeve']];
        
        specList.innerHTML = specs.map(s => `
            <li class="flex justify-between border-b border-gray-100 pb-2">
                <span>${s[0]}</span> 
                <span class="font-bold text-slate-800">${res.spec[s[1]]} cm</span>
            </li>
        `).join('');
    }

for (const key in trackers) {
        const el = trackers[key].el;
        if (el && res.spec[key]) {
            const statusData = res.analysis[key] || { text: '標準', class: 'status-just' };
            
            // 数値（cm）の書き換え
            const valueEl = el.querySelector('.value-text');
            if (valueEl) valueEl.textContent = `${res.spec[key]}cm`;
            
            // フィット感（タイト/標準/ゆったり）の書き換え
            const fitEl = el.querySelector('.fit-text');
            if (fitEl) {
                fitEl.textContent = statusData.text;
                fitEl.className = `fit-text text-[9px] ${statusData.class}`;
            }
        }
    }
}

function updateAnnotationDOM(id, value) {
    const el = document.getElementById(`annotation-${id}`);
    if (!el) return;
    const statusEl = el.querySelector('.status');
    // 数値を表示（例: 75cm）
    statusEl.textContent = `${value}cm`;
    statusEl.className = 'status font-bold text-[#8707ff]'; // 数値を目立たせる色に変更
    el.style.display = 'flex';
}

    // --- POPUP Logic ---
    function closePopup() {
        document.getElementById('email-popup').classList.add('hidden');
    }

    function handleEmailSubmit(e) {
        e.preventDefault();
        
        const email = document.getElementById('email-input').value;
        const consent = document.getElementById('consent-check').checked;
        const btn = document.getElementById('email-submit-btn');
        
        if(!consent) {
            showToast("利用規約への同意が必要です");
            return;
        }

        const originalText = btn.innerText;
        btn.innerHTML = '<div class="loader" style="width:16px; height:16px; border-width:2px;"></div>';
        btn.disabled = true;

        const postData = {
            type: 'email_signup',
            email: email,
            consent: consent
        };

        fetch(GAS_API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(postData)
        })
        .then(() => {
            // ★ MARK AS REGISTERED (Save to LocalStorage "Cookie")
            localStorage.setItem('fvvyn_email_registered', 'true');

            btn.innerHTML = '<i class="fa-solid fa-check"></i> 送信完了';
            showToast("クーポンコードをメールで送信しました。");
            
            setTimeout(() => {
                closePopup();
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        })
        .catch(err => {
            console.error(err);
            btn.innerText = "エラーが発生しました";
            btn.disabled = false;
        });
    }

    // --- THREE.JS Implementation ---
// --- THREE.JS Implementation ---
let scene, camera, renderer, mannequin, controls, animationId;

// ピン（アノテーション）の定義
const trackers = {
    // トップス用
    shoulder: { el: null, localPos: new THREE.Vector3(-0.3, 2.12, 0.0), label: 'Shoulder' }, 
    chest:    { el: null, localPos: new THREE.Vector3(0, 1.8, 0.15),   label: 'Chest' }, 
    sleeve:   { el: null, localPos: new THREE.Vector3(0.8, 1.75, 0.0),  label: 'Sleeve' },
    // パンツ用
    waist:    { el: null, localPos: new THREE.Vector3(0.2, 1.33, 0.18),   label: 'Waist' },
    length:   { el: null, localPos: new THREE.Vector3(-0.25, 0.6, 0.1), label: 'Length' },
    inseam:   { el: null, localPos: new THREE.Vector3(0.29, 0.8, 0.05),  label: 'Inseam' }
};
    
    function disposeHierarchy (node) {
        for (var i = node.children.length - 1; i >= 0; i--) {
            var child = node.children[i];
            disposeHierarchy(child);
            scene.remove(child);
        }
        if (node.geometry) {
            node.geometry.dispose();
        }
        if (node.material) {
            if (node.material.length) {
                for (let i = 0; i < node.material.length; ++i) {
                    node.material[i].dispose();
                }
            } else {
                node.material.dispose();
            }
        }
    }

    function cleanup3DScene() {
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        if (scene) {
            disposeHierarchy(scene);
            scene = null;
        }
        if (renderer) {
            renderer.dispose();
            const container = document.getElementById('canvas-container');
            if (container && renderer.domElement) {
                 container.removeChild(renderer.domElement);
            }
            renderer = null;
        }
        if (controls) {
            controls.dispose();
            controls = null;
        }
        window.removeEventListener('resize', onWindowResize);
    }

    function createFallbackMannequin() {
        const fallbackGroup = new THREE.Group();
        const mat = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.8 });
        const torso = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.3), mat);
        torso.position.y = 1.0;
        fallbackGroup.add(torso);
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.15, 16, 16), mat);
        head.position.y = 1.55;
        fallbackGroup.add(head);
        return fallbackGroup;
    }

function init3DScene(result) {
    cleanup3DScene();
    
    try {
        const container = document.getElementById('canvas-container');
        
        // アノテーション要素をすべて生成
// init3DScene 関数内の container.innerHTML 書き換え
container.innerHTML = `
    ${Object.keys(trackers).map(key => `
        <div id="annotation-${key}" class="annotation" style="display: none;">
            <span class="label">${trackers[key].label}</span>
            <div class="status-container">
                <span class="value-text text-[11px] font-black text-[#8707ff]"></span>
                <span class="fit-text text-[9px]"></span>
            </div>
        </div>
    `).join('')}
`;

        // トラッカーとDOM要素の紐付け
        for (const key in trackers) {
            trackers[key].el = document.getElementById(`annotation-${key}`);
        }

        renderResult(result);
        
        // ...（以下、cameraやrendererの設定は既存のまま）
        trackers.shoulder.el = document.getElementById('annotation-shoulder');
        trackers.chest.el = document.getElementById('annotation-chest');
        trackers.sleeve.el = document.getElementById('annotation-sleeve');

        // 3. シーンとカメラの設定
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf1f5f9); 

        camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
        
        // ★ アイテム種別によるカメラ初期位置の分岐
        if (state.product === 'cloud-pants') {
            camera.position.set(1.2, 0.5, 1.5);   // パンツ用 低い位置から


               //：X: 左右（プラスで右へ、マイナスで左へ）
              // Y: 高さ（プラスで上へ、マイナスで下へ）
             // Z: 距離（プラスで手前へ、マイナスで奥へ）


        } else {
            camera.position.set(0.25, 3.8, 0.1); // トップス用：高い位置から
        }

        // 4. レンダラーの設定
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);
        
        // リサイズ処理の実行
        onWindowResize(); 

        // 5. ライティング
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
        dirLight.position.set(2, 5, 2);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // 6. 地面（シャドウ受け用）
        const planeGeo = new THREE.PlaneGeometry(10, 10);
        const planeMat = new THREE.MeshStandardMaterial({ color: 0xdddddd });
        const plane = new THREE.Mesh(planeGeo, planeMat);
        plane.rotation.x = -Math.PI / 2;
        plane.receiveShadow = true;
        scene.add(plane);

        // 7. 3Dモデル（マネキン）のロード
        const loader = new THREE.GLTFLoader();
        const modelPath = 'mannequin.glb'; 

        loader.load(
            modelPath,
            (gltf) => {
                mannequin = gltf.scene;
                const isMobile = window.innerWidth < 768;
                const scale = isMobile ? 0.9 : 0.8;
                mannequin.scale.set(scale, scale, scale);
                mannequin.position.y = 0; 
                mannequin.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                scene.add(mannequin);
                onModelReady(result);
            },
            undefined,
            (error) => {
                console.error('GLBロードエラー。代替マネキンを生成します。', error);
                mannequin = createFallbackMannequin();
                scene.add(mannequin);
                // 代替モデル用のアノテーション位置調整
                trackers.shoulder.localPos.set(0.35, 1.3, 0);
                trackers.chest.localPos.set(0, 1.0, 0.2);
                trackers.sleeve.localPos.set(0.5, 1.0, 0);
                onModelReady(result);
            }
        );

        // 8. マウス・タッチ操作（OrbitControls）
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        
        // ★ アイテム種別による注視点（ターゲット）の分岐
        if (state.product === 'cloud-pants') {
            controls.target.set(0, 0.6, 0); // 下半身を画面中央に
        } else {
            controls.target.set(0, 1.2, 0); // 上半身を画面中央に
        }

        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = true; 
        controls.autoRotate = true;          
        controls.autoRotateSpeed = 2.0;      
        controls.minDistance = 2.0;
        controls.maxDistance = 6.0;
        controls.minPolarAngle = Math.PI / 4; 
        controls.maxPolarAngle = Math.PI * 0.55; 

        window.addEventListener('resize', onWindowResize, false);

    } catch (error) {
        console.error("Three.js initialization error:", error);
        cleanup3DScene();
        const container = document.getElementById('canvas-container');
        container.innerHTML = `<div class="p-4 text-center text-red-500 font-bold">3Dモデルの表示に失敗しました。</div>`;
    }
}

function onModelReady(resultData) {
    addGarmentLayer(resultData);
    if (mannequin) {
        // アイテムに応じてターゲット（注視点）を再設定
        if (state.product === 'cloud-pants') {
            controls.target.set(0, 0.6, 0); // 下半身に固定
        } else {
            controls.target.set(0, 1.2, 0); // 上半身に固定
        }
    }
    controls.update();
    if (!animationId) animate();
}

function addGarmentLayer(result) {
    if (!mannequin) return;
    
    // パンツの場合は一旦レイヤー追加をスキップ（トップス用の計算でNaNになるのを防ぐ）
    if (state.product === 'cloud-pants') return;

    const garmentColor = 0; 
    const garmentOpacity = 0; 
    const scaleFactor = 0.0055; 
    const modelScale = mannequin.scale.y;

    const garmentChest = result.spec.chest * scaleFactor * modelScale; 
    const garmentLength = result.spec.length * scaleFactor * modelScale; 
    const garmentShoulder = result.spec.shoulder * scaleFactor * modelScale * 2.0; 
    
    const garmentGeo = new THREE.BoxGeometry(garmentShoulder, garmentLength, garmentChest / 2.5); 
    const garmentMaterial = new THREE.MeshStandardMaterial({
        color: garmentColor,
        transparent: true,
        opacity: garmentOpacity,
        side: THREE.DoubleSide, 
        wireframe: false
    });
    
    const garment = new THREE.Mesh(garmentGeo, garmentMaterial);
    
    garment.position.y = (1.3 * modelScale); 
    garment.castShadow = false; 
    
    mannequin.add(garment);
    trackers.chest.localPos.set(0, 1.8, (garmentChest / 5) + 0.15); 
}

    function onWindowResize() {
        if (!camera || !renderer) return;
        const container = document.getElementById('canvas-container');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }

    document.getElementById('result-view').addEventListener('scroll', function() {
        const indicator = document.getElementById('scroll-indicator');
        if (indicator && this.scrollTop > 20) {
            indicator.style.opacity = '0';
            indicator.style.transition = 'opacity 0.5s';
            setTimeout(() => indicator.style.display = 'none', 500);
        }
    }, { passive: true });

    function animate() {
        if (!renderer) return;
        animationId = requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
        updateAnnotations();
    }
// --- UI Logic 修正 ---
    function updateUI(step) {
      state.step = step;
      steps.forEach(s => {
        s.classList.add('hidden');
        s.classList.remove('fade-in');
      });
      
      const targetStep = document.querySelector(`[data-step="${step}"]`);
      targetStep.classList.remove('hidden');
      void targetStep.offsetWidth; 
      targetStep.classList.add('fade-in');

      // プログレスバー（最上部）の更新
      const percentage = (step / 4) * 100;
      progressBar.style.width = percentage + '%';
      
      // ヘッダーテキストの更新
      stepIndicator.textContent = step === 4 ? "RESULT" : `Step ${step} / 4`;

      // ★追加：4ステップガイドの色更新ロジック
      document.querySelectorAll('.guide-item').forEach(item => {
        const gStep = parseInt(item.getAttribute('data-gstep'));
        if (gStep <= step) {
          item.classList.add('completed');
        } else {
          item.classList.remove('completed');
        }
      });

      backBtn.classList.toggle('hidden', step === 1);
      
      if (step === 4) {
        navControls.classList.add('hidden');
      } else {
        navControls.classList.remove('hidden');
      }
    }
function updateAnnotations() {
    if (!renderer || !camera || !mannequin) return;

    const width = renderer.domElement.clientWidth;
    const height = renderer.domElement.clientHeight;
    const widthHalf = width / 2;
    const heightHalf = height / 2;

    const isPants = state.product === 'cloud-pants';
    const pantsKeys = ['waist', 'length', 'inseam'];
    const topKeys = ['shoulder', 'chest', 'sleeve'];

    for (const key in trackers) {
        const t = trackers[key];
        if (!t.el) continue;

        // --- 追加：アイテムタイプによる出し分けロジック ---
        const isRelevant = isPants ? pantsKeys.includes(key) : topKeys.includes(key);
        
        if (!isRelevant) {
            t.el.style.display = 'none';
            continue; // このピンの計算をスキップ
        }
        // ----------------------------------------------

        const pos = t.localPos.clone().applyMatrix4(mannequin.matrixWorld);
        pos.project(camera);

        const x = (pos.x * widthHalf) + widthHalf;
        const y = -(pos.y * heightHalf) + heightHalf;

        // カメラの視界内（前面）にある場合のみ表示
 if (pos.z < 1 && x > 0 && x < width && y > 0 && y < height) {
        t.el.style.display = 'flex';
        t.el.style.left = `${x}px`;
        t.el.style.top = `${y}px`;
        
        // 特定の部位のみ少し上にずらす調整（必要であれば）
        if (key === 'shoulder' || key === 'sleeve') {
            t.el.style.top = `${y - 30}px`; // 以前より少し控えめな調整
        }
    } else {
        t.el.style.display = 'none';
    }
}
}
    function openGuide() {
    const guide = document.getElementById('guide-popup');
    guide.classList.remove('hidden');
    // 開く時のアニメーションをリセットするために一度クラスを外して付ける
    guide.querySelector('.modal-animate').style.animation = 'none';
    guide.querySelector('.modal-animate').offsetHeight; /* trigger reflow */
    guide.querySelector('.modal-animate').style.animation = null;
}

function closeGuide() {
    document.getElementById('guide-popup').classList.add('hidden');
}

// 405行目付近（修正前）

    updateUI(1);

    document.getElementById('height-range').oninput({ target: { value: 170 }});
    document.getElementById('weight-range').oninput({ target: { value: 60 }});
  </script>
<button onclick="openGuide()" class="fixed bottom-32 right-6 w-12 h-12 bg-white text-[#8707ff] rounded-full shadow-lg border border-purple-50 flex items-center justify-center z-[100] font-black text-xl btn-pulse cursor-pointer">
  ?
</button>

<div id="guide-popup" class="fixed inset-0 z-[110] hidden flex items-center justify-center px-4">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeGuide()"></div>
  
  <div class="bg-white rounded-[32px] p-8 w-full max-w-sm shadow-2xl relative z-20 modal-animate">
    <button onclick="closeGuide()" class="absolute top-5 right-5 text-gray-400 hover:text-gray-600">
      <i class="fa-solid fa-xmark text-xl"></i>
    </button>

    <div class="text-center mb-6">
      <div class="inline-block px-3 py-1 bg-purple-100 text-[#8707ff] text-[10px] font-bold rounded-full mb-2 uppercase tracking-widest">How to use</div>
      <h3 class="text-xl font-black text-slate-800">使い方ガイド</h3>
    </div>

    <div class="space-y-4 text-left">
      <div class="guide-step-box pl-4 py-1">
        <p class="text-[10px] font-bold text-[#8707ff]">STEP 01</p>
        <p class="text-sm font-bold text-slate-700">アイテムを選ぶ</p>
        <p class="text-[11px] text-gray-500">診断したいアイテムをタップして選択します。</p>
      </div>
      <div class="guide-step-box pl-4 py-1">
        <p class="text-[10px] font-bold text-[#8707ff]">STEP 02</p>
        <p class="text-sm font-bold text-slate-700">フィット感を決める</p>
        <p class="text-[11px] text-gray-500">タイトめ〜ゆったり等、お好みの着心地を選びます。</p>
      </div>
      <div class="guide-step-box pl-4 py-1">
        <p class="text-[10px] font-bold text-[#8707ff]">STEP 03</p>
        <p class="text-sm font-bold text-slate-700">体型データを入力</p>
        <p class="text-[11px] text-gray-500">身長・体重のスライダーを自分の数値に合わせます。</p>
      </div>
      <div class="guide-step-box pl-4 py-1">
        <p class="text-[10px] font-bold text-[#8707ff]">STEP 04</p>
        <p class="text-sm font-bold text-slate-700">AIが3Dで提案</p>
        <p class="text-[11px] text-gray-500">最適なサイズと、着用イメージが3Dで表示されます。</p>
      </div>
    </div>

    <button onclick="closeGuide()" class="w-full mt-8 py-4 rounded-full bg-[#8707ff] text-white font-bold text-sm shadow-lg shadow-purple-200">
      Bet
    </button>
  </div>
</div>

</body>
</html>


