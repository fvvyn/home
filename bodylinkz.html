<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Google Analytics / Tag Manager (From Bodylinkz.html) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MF598BWN4M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-MF598BWN4M');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- Meta Tags & Title Restored from Bodylinkz.html -->
  <title>fvvyn | Bodylinkz サイズ提案システム - 最適なサイズをご提案</title>
  <meta name="description" content="fvvynによるBodylinkz独自のAIが、身長・体重・フィット感から理想のサイズをパーソナライズ診断。失敗しないサイズ選びを体験しましょう。" />
  <link rel="canonical" href="https://fvvyn.com/bodylinkz/size-recommender" /> 
  <meta property="og:title" content="fvvyn| Bodylinkz サイズ提案システム" />
  <meta property="og:description" content="理想のサイズをAIが提案。fvvynアイテムによるサイズ不安を解消しましょう。" />
  <meta property="og:url" content="https://fvvyn.com/bodylinkz/size-recommender" /> 
  <meta property="og:site_name" content="fvvyn©︎公式 | Bodylinkz" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://fvvyn.com/images/bodylinkz-ogp.jpg" /> 
  <meta name="twitter:card" content="summary_large_image" /> 
  <meta name="twitter:creator" content="@fvvyn_official" />
  <meta name="robots" content="index, follow">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Three.js Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script> 

  <style>
    :root {
      --primary: #8707ff;
      --primary-dark: #6a00cd;
      --bg-color: #f8fafc;
      --text-main: #1e293b;
    }
/* 1. bodyのoverflow-x: hiddenを維持しつつ、縦スクロールを自然にする */
body { 
    font-family: 'Inter', sans-serif; 
    background-color: var(--bg-color); 
    color: var(--text-main); 
    /* touch-action: manipulation; はそのままでOK */
}

/* 2. 3Dコンテナの高さを「固定」ではなく「最低高さ」に変更 */
/* 結果画面全体を少し内側に寄せる設定 */
/* #result-view を以下に書き換え（!important を追加） */
#result-view {
    width: 100% !important;
    padding-left: 16px !important;  /* 左右に強制的に隙間を作る */
    padding-right: 16px !important;
    padding-top: 10px !important;    /* 上にも少し隙間があると綺麗です */
    box-sizing: border-box !important;
}

/* #canvas-container はそのままでOKですが、
   もし枠自体が太すぎると感じたら width を 95% くらいに微調整してください */
/* 既存の #canvas-container の記述をすべて削除するか、末尾にこれを追加してください */
#canvas-container {
    width: 100% !important;
    height: 350px !important;    /* 固定の高さを指定 */
    min-height: 350px !important; 
    position: relative !important;
    background: radial-gradient(circle at center, #ffffff 0%, #f1f5f9 100%) !important;
    border-radius: 20px !important;
    overflow: hidden !important;
    margin-bottom: 30px !important;
    border: 1px solid #d1d5db !important;
    box-sizing: border-box !important;
}

/* モバイル対応：画面が小さい場合は高さを少し削る */
@media (max-height: 700px) {
    #canvas-container {
        height: 300px !important;
        min-height: 300px !important;
    }
}

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }

    /* UI Components */
    .card-select {
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      border: 2px solid transparent;
    }
    .card-select:active { transform: scale(0.98); }
    .card-select.selected {
      border-color: var(--primary);
      background-color: #f3e8ff;
      color: var(--primary-dark);
      box-shadow: 0 4px 12px rgba(135, 7, 255, 0.15);
    }
    
    /* Range Slider */
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 24px; width: 24px;
      border-radius: 50%; background: var(--primary);
      cursor: pointer; margin-top: -10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); border: 2px solid white;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 6px; cursor: pointer;
      background: #e2e8f0; border-radius: 3px;
    }

    /* 3D Canvas Container */
    #canvas-container {
      width: 100%;
      height: 350px;
      position: relative;
      background: radial-gradient(circle at center, #ffffff 0%, #f1f5f9 100%);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    @media (min-width: 768px) {
        #canvas-container {
            height: 450px;
        }
    }
    
    /* 3D Annotations */
    .annotation {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 700;
      color: #334155;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translate(-50%, -50%);
      white-space: nowrap;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: opacity 0.3s;
      z-index: 10;
    }
    .annotation::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 6px 6px 0;
      border-style: solid;
      border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent;
    }
    .annotation span.status {
      display: block;
      font-size: 10px;
      margin-top: 2px;
    }
    .status-tight { color: #ef4444; }
    .status-just { color: #10b981; }
    .status-loose { color: #3b82f6; }

    /* Loader */
    .loader {
      border: 3px solid #f3f3f3; border-top: 3px solid var(--primary);
      border-radius: 50%; width: 30px; height: 30px;
      animation: spin 1s linear infinite; margin: 0 auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Glass Panel */
    .glass-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    /* Toast */
    .toast {
      visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff;
      text-align: center; border-radius: 50px; padding: 12px 24px;
      position: fixed; z-index: 50; left: 50%; bottom: 30px;
      transform: translateX(-50%); font-size: 14px; font-weight: 500;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .toast.show { visibility: visible; animation: slideUpFade 0.5s, fadeOut 0.5s 2.5s forwards; }
    @keyframes slideUpFade { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    @keyframes fadeOut { from {opacity: 1;} to {opacity: 0;} }
/* アニメーションの定義 */
@keyframes bounce {
  0%, 100% { transform: translateY(0) translateX(-50%); }
  50% { transform: translateY(10px) translateX(-50%); }
}

.animate-bounce {
  animation: bounce 2s infinite;
}

/* 3Dエリアの高さが足りないとスクロールが発生しないため、
   スマホでの最小高さを少し高めに設定します */
#canvas-container {
    min-height: 400px; /* 500px以上を推奨 */
    #canvas-container {
    width: 100%;
    min-height: 550px; /* ここを 500〜550 くらいにするとスクロールしやすくなります */
    position: relative;
    overflow: hidden;
    
}
}

/* 結果表示画面のスクロールを滑らかにする */

#result-view {
    scroll-behavior: smooth;
    overflow-y: auto;
    padding-bottom: 100px !important; /* 下部固定ボタンの高さ分を確保 */
}
/* fit ANALYTICSバーが含まれる親要素のスタイルを修正 */
.px-6.mb-6 > .bg-slate-50 {
    background-color: transparent !important; /* 背景を透明に */
    border: none !important;                /* 枠線を消す */
    box-shadow: none !important;            /* 影を消す */
    padding-top: 0 !important;              /* 余白の調整 */
}

/* バー自体の背景色を少し濃くして見やすくする場合（任意） */
#fit-indicator-bar {
    background-color: rgba(197, 142, 248, 0.8) !important; 
}
/* 右下固定の3D移動ボタン */
.scroll-to-3d-btn {
    position: fixed;
    right: 20px;
    bottom: 100px; /* 「このサイズで購入」ボタンに被らないよう調整 */
    width: 60px;
    height: 60px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 900;
    box-shadow: 0 4px 15px rgba(135, 7, 255, 0.4);
    cursor: pointer;
    z-index: 40; /* 下部ボタンより上に表示 */
    transition: all 0.3s ease;
    border: 2px solid white;
    line-height: 1.2;
}

.scroll-to-3d-btn:active {
    transform: scale(0.9);
}

.scroll-to-3d-btn i {
    font-size: 16px;
    margin-bottom: 2px;
}
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-0 md:p-4 bg-slate-50">

  <div class="w-full md:max-w-md h-screen md:h-auto glass-panel md:shadow-2xl md:rounded-[32px] overflow-hidden relative flex flex-col bg-white">
    
    <div class="absolute top-0 left-0 w-full h-1 bg-gray-100 z-20">
      <div id="progress-bar" class="h-full bg-[#8707ff] transition-all duration-500 ease-out" style="width: 25%"></div>
    </div>

    <header class="pt-6 px-6 pb-2 text-center flex-shrink-0 z-10 bg-white md:bg-transparent">
      <h1 class="text-xl font-black tracking-tight text-slate-800">fvvyn <span class="text-[#8707ff] font-light">Bodylinkz</span></h1>
      <p class="text-[10px] text-gray-400 mt-1 tracking-widest uppercase font-medium" id="step-indicator">Step 1 / 3</p>
    </header>

    <div id="step-container" class="relative flex-1 overflow-hidden">

      <div data-step="1" class="step-content fade-in h-full flex flex-col p-6 overflow-y-auto">
        <h2 class="text-lg font-bold text-slate-700 mb-4 text-center">どのアイテムをお探しですか？</h2>
        <div class="grid grid-cols-2 gap-3 flex-1 content-start" id="product-grid">
          
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 h-36" onclick="selectProduct('slash-tshirt', this)">
            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm text-gray-400 text-xl"><i class="fa-solid fa-shirt"></i></div>
            <span class="text-xs font-bold text-center">Slash Tshirts</span>
          </div>
          
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 h-36" onclick="selectProduct('logo-tshirt', this)">
            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm text-gray-400 text-xl"><i class="fa-solid fa-shirt"></i></div>
            <span class="text-xs font-bold text-center">Logo Tshirts</span>
          </div>
          
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 h-36" onclick="selectProduct('lamp-zip-hoodie', this)">
            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm text-gray-400 text-xl"><i class="fa-solid fa-vest"></i></div>
            <span class="text-xs font-bold text-center">Lamp Zip Hoodie</span>
          </div>

          <!-- Added Beg Zip Hoodie from Bodylinkz.html 
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 h-36" onclick="selectProduct('beg-zip-hoodie', this)">
            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm text-gray-400 text-xl"><i class="fa-solid fa-vest"></i></div>
            <span class="text-xs font-bold text-center">Beg Zip Hoodie</span>
          </div>-->
          
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex flex-col items-center justify-center gap-3 h-36" onclick="selectProduct('cloudy-zip-hoodie', this)">
             <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm text-gray-400 text-xl"><i class="fa-solid fa-cloud"></i></div>
             <!-- Text restored from Bodylinkz.html -->
             <span class="text-xs font-bold text-center">CLOUD ZIP HOODIE⛈️</span>
          </div>
        </div>
        <input type="hidden" id="product">
      </div>

      <div data-step="2" class="step-content hidden fade-in h-full flex flex-col p-6">
        <h2 class="text-lg font-bold text-slate-700 mb-4 text-center">好みのフィット感を選択してください</h2>
        <div class="flex flex-col gap-3" id="fit-grid">
          <!-- Texts restored from Bodylinkz.html (e.g. ストリート instead of リラックス) -->
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex items-center gap-4" onclick="selectFit('slim', this)">
            <div class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400"><i class="fa-solid fa-child-reaching"></i></div>
            <div class="text-left">
              <p class="font-bold text-sm text-slate-800">Slim Fit</p>
              <p class="text-[11px] text-gray-500 mt-0.5">タイトめ / すっきり</p>
            </div>
          </div>
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex items-center gap-4" onclick="selectFit('standard', this)">
            <div class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400"><i class="fa-solid fa-child"></i></div>
            <div class="text-left">
              <p class="font-bold text-sm text-slate-800">Standard Fit</p>
              <p class="text-[11px] text-gray-500 mt-0.5">標準 / ジャストサイズ</p>
            </div>
          </div>
          <div class="card-select bg-slate-50 p-4 rounded-2xl flex items-center gap-4" onclick="selectFit('oversized', this)">
            <div class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400"><i class="fa-solid fa-person-rays"></i></div>
            <div class="text-left">
              <p class="font-bold text-sm text-slate-800">Oversized</p>
              <p class="text-[11px] text-gray-500 mt-0.5">ゆったり / ストリート</p>
            </div>
          </div>
        </div>
        <input type="hidden" id="fit">
      </div>

      <div data-step="3" class="step-content hidden fade-in h-full flex flex-col p-6">
        <h2 class="text-lg font-bold text-slate-700 mb-8 text-center">あなたの体型について</h2>
        
        <div class="mb-10 bg-slate-50 p-6 rounded-3xl">
          <div class="flex justify-between items-end mb-6">
            <label class="text-sm font-bold text-gray-500 flex items-center gap-2"><i class="fa-solid fa-ruler-vertical"></i> 身長</label>
            <span class="text-3xl font-black text-[#8707ff]"><span id="height-val">170</span> <span class="text-sm text-gray-400 font-medium">cm</span></span>
          </div>
          <input type="range" id="height-range" min="140" max="210" value="170" class="w-full accent-[#8707ff]" oninput="syncInput('height', this.value)">
          <div class="flex justify-between text-[10px] text-gray-400 mt-2 font-medium tracking-wide">
              <span>140cm</span>
              <span>210cm</span>
          </div>
          <input type="number" id="height" class="hidden" value="170"> 
        </div>

        <div class="mb-4 bg-slate-50 p-6 rounded-3xl">
          <div class="flex justify-between items-end mb-6">
            <label class="text-sm font-bold text-gray-500 flex items-center gap-2"><i class="fa-solid fa-weight-scale"></i> 体重</label>
            <span class="text-3xl font-black text-[#8707ff]"><span id="weight-val">60</span> <span class="text-sm text-gray-400 font-medium">kg</span></span>
          </div>
          <input type="range" id="weight-range" min="30" max="130" value="60" class="w-full accent-[#8707ff]" oninput="syncInput('weight', this.value)">
           <div class="flex justify-between text-[10px] text-gray-400 mt-2 font-medium tracking-wide">
              <span>30kg</span>
              <span>130kg</span>
          </div>
          <input type="number" id="weight" class="hidden" value="60"> 
        </div>
      </div>

      <div data-step="4" class="step-content hidden h-full flex flex-col relative">
        
        <div id="loading-view" class="absolute inset-0 bg-white z-20 flex flex-col items-center justify-center hidden">
          <div class="loader mb-4"></div>
          <p class="text-xs text-gray-500 font-medium tracking-widest animate-pulse">AI Analyzing...</p>
        </div>

<div id="result-view" class="flex-1 flex flex-col h-full overflow-y-auto bg-white fade-in">
  
  <div class="px-6 pt-6 pb-4 text-center">
    <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-1">Recommended Size</p>
    <div class="flex items-baseline justify-center gap-2">
        <span id="recommended-size" class="text-5xl font-black text-[#8707ff]">L</span>
        <span class="text-sm text-gray-500 font-medium">がおすすめです</span>
    </div>
    <p id="product-name-display" class="text-xs text-gray-400 mt-1">Product Name</p>
  </div>

  <div class="px-6 mb-6">
    <div class="bg-slate-50 rounded-2xl p-5 border border-slate-100">
      <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-4 text-center">Fit Analysis</p>
      <div id="fit-indicator-bar" class="relative w-full h-2 bg-gray-200 rounded-full mb-6">
        <div class="absolute w-full flex justify-between -top-1 px-1">
          <span class="w-1 h-4 bg-white border border-gray-200 rounded-full"></span>
          <span class="w-1 h-4 bg-white border border-gray-200 rounded-full"></span>
          <span class="w-1 h-4 bg-white border border-gray-200 rounded-full"></span>
        </div>
        <div id="fit-pin" class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 transition-all duration-1000 ease-out" style="left: 50%;">
          <div class="w-4 h-4 bg-[#8707ff] rounded-full border-2 border-white shadow-md"></div>
          <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 text-[10px] font-bold whitespace-nowrap text-[#8707ff]" id="fit-label">
            Standard
          </div>
        </div>
      </div>
      <div class="flex justify-between text-[9px] text-gray-400 font-bold uppercase tracking-tighter">
        <span>Tight</span>
        <span>Optimal</span>
        <span>Loose</span>
      </div>
    </div>
  </div>

  <div class="px-7 mt-0.5 mb-3.5">
      <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
          <i class="fa-solid fa-person-half-dress text-[#8707ff]"></i>　3Dフィッティング・プレビュー
      </h3>
      <p class="text-[11px] text-gray-500 mt-1 leading-relaxed">
          AIが算出した体型データを元に、推奨サイズの着用感をシミュレートしています。肩幅・身幅・袖丈のゆとりを確認してください。
      </p>
  </div>

  <div id="canvas-container" class="relative">
      <div id="annotation-shoulder" class="annotation" style="display: none;">
        <span class="label text-[9px] text-gray-400 uppercase">Shoulder</span>
        <span class="status font-bold"></span>
      </div>
      <div id="annotation-chest" class="annotation" style="display: none;">
        <span class="label text-[9px] text-gray-400 uppercase">Chest</span>
        <span class="status font-bold"></span>
      </div>
      <div id="annotation-sleeve" class="annotation" style="display: none;">
        <span class="label text-[9px] text-gray-400 uppercase">Sleeve</span>
        <span class="status font-bold"></span>
      </div>

      <div class="absolute bottom-4 left-0 w-full text-center pointer-events-none">
          <p class="text-[10px] text-gray-400 bg-white/80 inline-block px-3 py-1 rounded-full backdrop-blur-sm">
              <i class="fa-solid fa-arrows-up-down-left-right mr-1"></i> 回転 / ズーム
          </p>
      </div>
      
      <div id="scroll-indicator" class="absolute top-4 left-1/2 -translate-x-1/2 flex flex-col items-center animate-bounce text-slate-400 pointer-events-none z-30">
          <span class="text-[10px] font-bold uppercase tracking-widest mb-1">Scroll to view 3D</span>
          <i class="fa-solid fa-chevron-down text-lg"></i>
      </div>
  </div>

  <div class="px-6 mt-6 pb-4">
    <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
        <i class="fa-solid fa-chart-simple text-[#8707ff]"></i> サイズ詳細 (cm)
    </h3>
    <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 mb-2"> 
        <ul id="size-spec" class="grid grid-cols-2 gap-y-3 text-sm text-gray-600">
            </ul>
    </div>

<div class="py-4 px-5 -mx-2 mt-3 bg-purple-50 rounded-xl border border-purple-100 text-xs text-purple-800 leading-relaxed shadow-sm">
    <i class="fa-solid fa-circle-info mr-2"></i>
    <span id="result-message">メッセージ</span>
</div>
  </div>

  <div id="move-to-3d" class="scroll-to-3d-btn hidden" onclick="scrollTo3D()">
    <i class="fa-solid fa-cube"></i>
    <span>3D↓</span>
  </div>

  <div class="pt-10 pb-1 text-center">
      <p class="text-[10px] text-gray-400 font-medium tracking-tight">
          &copy; 2025 fvvyn. All Rights Reserved.
      </p>
      <p class="text-[9px] text-gray-300 mt-1">
          この技術はfvvynによって保護されています
      </p>
  </div>
  
  <div class="h-24"></div>
  
</div>

        <div class="absolute bottom-0 left-0 w-full p-4 bg-white/90 backdrop-blur-md border-t border-gray-100 flex gap-3 z-30">
            <button onclick="resetForm()" class="px-6 py-3 rounded-full border border-gray-200 text-gray-600 font-bold text-xs hover:bg-gray-50">
                再診断
            </button>
            <a href="https://fvvyn.com" target="_blank" class="flex-1 bg-[#1e293b] text-white flex items-center justify-center gap-2 py-3 rounded-full font-bold text-sm shadow-lg hover:bg-black transition-all">
                このサイズで購入 <i class="fa-solid fa-arrow-right"></i>
            </a>
        </div>
      </div>

    </div>

    <div id="nav-controls" class="p-6 bg-white border-t border-gray-50 flex gap-3 flex-shrink-0 z-10">
      <button id="back-button" class="flex-1 py-3 rounded-full border border-gray-200 text-gray-500 font-bold text-sm hover:bg-gray-50 transition-colors hidden focus:outline-none">戻る</button>
      <button id="next-button" class="flex-1 py-3 rounded-full bg-[#8707ff] text-white font-bold text-sm shadow-lg shadow-purple-200 hover:bg-[#6a00cd] hover:shadow-purple-300 transition-all active:scale-95">次へ</button>
    </div>
  </div>

  <div id="toast" class="toast">Message Here</div>

  <script>
    // --- GAS Settings (From Bodylinkz.html) ---
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyrnuyKZiEgTPSYAPT5CL3D_t7-ToXUoelqXi40NW0-FwAG65XRZ9vqcVrbcYwuOdDQ7A/exec";

    // --- Data Definition ---
    const PRODUCT_SIZES = {
      'slash-tshirt': {
        name: "Slash Tshirts",
        S: { height:[150,160], weight:[40,55], length:66, chest:98, shoulder:44, sleeve:19 },
        M: { height:[160,170], weight:[50,65], length:70, chest:104, shoulder:47, sleeve:20 },
        L: { height:[170,180], weight:[60,75], length:74, chest:110, shoulder:50, sleeve:22 },
        XL: { height:[180,190], weight:[70,85], length:78, chest:116, shoulder:53, sleeve:24 },
        XXL: { height:[185,195], weight:[80,95], length:82, chest:122, shoulder:56, sleeve:26 },
        XXXL: { height:[190,200], weight:[90,105], length:84, chest:128, shoulder:59, sleeve:26 }
      },
      'logo-tshirt': {
        name: "Logo Tshirts",
        S: { height:[150,160], weight:[40,55], length:66, chest:98, shoulder:44, sleeve:19 },
        M: { height:[160,170], weight:[50,65], length:70, chest:104, shoulder:47, sleeve:20 },
        L: { height:[170,180], weight:[60,75], length:74, chest:110, shoulder:50, sleeve:22 },
        XL: { height:[180,190], weight:[70,85], length:78, chest:116, shoulder:53, sleeve:24 },
        XXL: { height:[185,195], weight:[80,95], length:82, chest:122, shoulder:56, sleeve:26 },
        XXXL: { height:[190,200], weight:[90,105], length:84, chest:128, shoulder:59, sleeve:26 }
      },
      // Added missing Beg Zip Hoodie
      'beg-zip-hoodie': {
        name: "Beg Zip Hoodie",
        S: { height:[155,165], weight:[45,60], length:55, chest:102, shoulder:60, sleeve:56.5 },
        M: { height:[165,175], weight:[55,70], length:57.5, chest:107, shoulder:62.5, sleeve:59 },
        L: { height:[175,185], weight:[65,80], length:60, chest:112, shoulder:65, sleeve:61.5 }
      },
      'lamp-zip-hoodie': {
        name: "Lamp Zip Hoodie",
        XS: { height:[150,160], weight:[40,55], length:52.5, chest:91, shoulder:70, sleeve:51 },
        S: { height:[160,170], weight:[50,65], length:55.5, chest:94, shoulder:72, sleeve:52 },
        M: { height:[170,180], weight:[60,75], length:58.5, chest:97, shoulder:74, sleeve:53 },
        L: { height:[180,190], weight:[70,85], length:61.5, chest:100, shoulder:76, sleeve:54 },
        XL: { height:[185,195], weight:[80,95], length:64.5, chest:103, shoulder:78, sleeve:55 }
      },
      'cloudy-zip-hoodie': {
        name: "CLOUDY ZIP HOODIE",
        XS: { height:[145,155], weight:[35,45], length:52.5, chest:97, shoulder:57.5, sleeve:54.0 }, 
        S: { height:[155,165], weight:[45,55], length:55.0, chest:102, shoulder:60.0, sleeve:56.5 },
        M: { height:[165,175], weight:[55,65], length:57.5, chest:107, shoulder:62.5, sleeve:59.0 },
        L: { height:[175,185], weight:[65,75], length:60.0, chest:112, shoulder:65.0, sleeve:61.5 }
      }
    };

    // Text messages restored from Bodylinkz.html
    const FIT_PRESETS = {
        'slim': { offset: -1, text: 'タイトなシルエットをご提案します。' },
        'standard': { offset: 0, text: 'スタンダードなサイズ感です。' },
        'oversized': { offset: 1, text: 'ゆとりあるサイズをご提案します。' }
    };

    // --- State Management ---
    const state = {
        step: 1,
        product: null,
        fit: null,
        height: 170,
        weight: 60
    };

    // --- UI Logic ---
    const steps = document.querySelectorAll('.step-content');
    const nextBtn = document.getElementById('next-button');
    const backBtn = document.getElementById('back-button');
    const navControls = document.getElementById('nav-controls');
    const progressBar = document.getElementById('progress-bar');
    const stepIndicator = document.getElementById('step-indicator');

    function updateUI(step) {
      state.step = step;
      steps.forEach(s => {
        s.classList.add('hidden');
        s.classList.remove('fade-in');
      });
      
      const targetStep = document.querySelector(`[data-step="${step}"]`);
      targetStep.classList.remove('hidden');
      void targetStep.offsetWidth; // Trigger reflow
      targetStep.classList.add('fade-in');

      const percentage = (step / 4) * 100;
      progressBar.style.width = percentage + '%';
      
      stepIndicator.textContent = step === 4 ? "RESULT" : `Step ${step} / 3`;

      // Button Visibility
      backBtn.classList.toggle('hidden', step === 1);
      
      // If result screen, hide normal nav controls
      if (step === 4) {
        navControls.classList.add('hidden');
      } else {
        navControls.classList.remove('hidden');
      }
    }

    nextBtn.onclick = () => {
      if (!validateStep()) return;
      if (state.step < 3) {
        updateUI(state.step + 1);
      } else {
        calculateAndShowResult();
      }
    };

    backBtn.onclick = () => {
        if (state.step > 1) {
             // Stop animation and clean up Three.js when leaving step 4
            if (state.step === 4) {
                cleanup3DScene();
            }
            updateUI(state.step - 1);
        }
    };

    function validateStep() {
      if (state.step === 1 && !state.product) { showToast('アイテムを選択してください'); return false; }
      if (state.step === 2 && !state.fit) { showToast('フィット感を選択してください'); return false; }
      return true;
    }

    window.selectProduct = (id, el) => {
      state.product = id;
      document.querySelectorAll('#product-grid .card-select').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      // Auto advance for smoother UX
      setTimeout(() => nextBtn.click(), 300);
    };

    window.selectFit = (id, el) => {
      state.fit = id;
      document.querySelectorAll('#fit-grid .card-select').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
       setTimeout(() => nextBtn.click(), 300);
    };

    window.syncInput = (key, val) => {
      state[key] = parseInt(val);
      document.getElementById(`${key}-val`).textContent = val;
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.className = "toast show";
        setTimeout(() => t.className = "toast", 3000);
    }

    window.resetForm = () => {
        state.product = null; state.fit = null; state.step = 1;
        document.querySelectorAll('.card-select').forEach(c => c.classList.remove('selected'));
        // Dispose 3D scene
        cleanup3DScene();
        updateUI(1);
    }

    /**
     * GASにデータを送信する関数 (Restored from Bodylinkz.html)
     */
    function sendDataToGAS(data) {
        fetch(GAS_API_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(() => {
            console.log("Data sent to spreadsheet.");
        })
        .catch(error => {
            console.error("Error sending data:", error);
        });
    }

    // --- Core Calculation & 3D Logic ---

    function calculateAndShowResult() {
        const loading = document.getElementById('loading-view');
        updateUI(4);
        loading.classList.remove('hidden');

        // Simulate processing time
        setTimeout(() => {
            const result = performCalculation();
            renderResult(result);
            init3DScene(result);
            
            // Send Data to GAS here
            const trackingData = {
                productId: state.product,
                productName: result.productName,
                height: state.height,
                weight: state.weight,
                fitPreference: state.fit,
                recommendedSize: result.recSize
            };
            sendDataToGAS(trackingData);

            loading.classList.add('hidden');
        }, 1500);
    }

    function performCalculation() {
        const data = PRODUCT_SIZES[state.product];
        const adjustment = FIT_PRESETS[state.fit];
        const h = state.height;
        const w = state.weight;
        const sizeKeys = Object.keys(data).filter(k => k !== 'name');

        // Simple Euclidean distance for best base size
        let bestDist = Infinity;
        let baseIdx = 0;

        sizeKeys.forEach((size, idx) => {
            const sData = data[size];
            const avgH = (sData.height[0] + sData.height[1]) / 2;
            const avgW = (sData.weight[0] + sData.weight[1]) / 2;
            // Weigh weight more than height for fit
            const dist = Math.abs(h - avgH) + (Math.abs(w - avgW) * 2.0);
            if (dist < bestDist) { bestDist = dist; baseIdx = idx; }
        });

        // Apply preference adjustment
        let finalIdx = baseIdx + adjustment.offset;
        finalIdx = Math.max(0, Math.min(finalIdx, sizeKeys.length - 1));
        const recSize = sizeKeys[finalIdx];

        // --- Fit Analysis Logic ---
        // Estimate Body Dimensions (Very rough approximation for demo)
        const estShoulder = (h * 0.23) + (w * 0.1); 
        const estChest = (h * 0.48) + (w * 0.25);
        const estArm = (h * 0.35) + (w * 0.05);

        const prod = data[recSize];
        
        // Compare Garment vs Body
        const analyze = (body, garment, type) => {
            let diff = garment - body;
            const looseThreshold = state.product.includes('hoodie') ? 15 : 10; 
            const tightThreshold = state.product.includes('hoodie') ? 6 : 4;
            
            if (diff < tightThreshold) return { status: 'Tight', class: 'status-tight', text: 'タイト' };
            if (diff > looseThreshold) return { status: 'Loose', class: 'status-loose', text: 'ゆったり' };
            return { status: 'Just Right', class: 'status-just', text: '標準' };
        };

        return {
            recSize,
            productName: data.name,
            spec: prod,
            analysis: {
                shoulder: analyze(estShoulder, prod.shoulder, 'shoulder'),
                chest: analyze(estChest, prod.chest, 'chest'),
                sleeve: analyze(estArm, prod.sleeve, 'sleeve')
            },
            message: adjustment.text
        };
    }



function renderResult(res) {
    document.getElementById('recommended-size').textContent = res.recSize;
    document.getElementById('product-name-display').textContent = res.productName;
    document.getElementById('result-message').textContent = res.message;

    // --- ここに以下の4行を追加 ---
    const pin = document.getElementById('fit-pin');
    const label = document.getElementById('fit-label');
    const status = res.analysis.chest.status; // 胸囲のフィット感を基準にします
    
    if (status === 'Tight') { pin.style.left = '15%'; label.textContent = 'タイト'; }
    else if (status === 'Loose') { pin.style.left = '85%'; label.textContent = 'ゆったり'; }
    else { pin.style.left = '50%'; label.textContent = 'ジャスト'; }
    // ----------------------------

    // 以下は既存の処理です
    const specList = document.getElementById('size-spec');
    specList.innerHTML = `
        <li class="flex justify-between border-b border-gray-100 pb-2"><span>着丈</span> <span class="font-bold text-slate-800">${res.spec.length}</span></li>
        
          
            <li class="flex justify-between border-b border-gray-100 pb-2"><span>身幅</span> <span class="font-bold text-slate-800">${res.spec.chest}</span></li>
            <li class="flex justify-between border-b border-gray-100 pb-2"><span>肩幅</span> <span class="font-bold text-slate-800">${res.spec.shoulder}</span></li>
            <li class="flex justify-between border-b border-gray-100 pb-2"><span>袖丈</span> <span class="font-bold text-slate-800">${res.spec.sleeve}</span></li>
        `;

        // Update Annotations DOM
        updateAnnotationDOM('shoulder', res.analysis.shoulder);
        updateAnnotationDOM('chest', res.analysis.chest);
        updateAnnotationDOM('sleeve', res.analysis.sleeve);
    }

    function updateAnnotationDOM(id, data) {
        const el = document.getElementById(`annotation-${id}`);
        if (!el) return; // Guard for cleanup
        const statusEl = el.querySelector('.status');
        statusEl.textContent = data.text; // Japanese text
        // Remove existing status classes and add new one
        statusEl.className = 'status font-bold';
        statusEl.classList.add(data.class);
    }

    // --- THREE.JS Implementation (GLB Loading with Zoom & Position Fixes) ---
    let scene, camera, renderer, mannequin, controls, animationId;
    
    // [修正] アノテーション位置の調整 (Tポーズのマネキンに合わせて座標を再設定)
    const trackers = {
        // 肩: 少し低く、外側に移動 (Y: 1.4, X: 0.5)
        shoulder: { pos: new THREE.Vector3(0, 0, 0), el: null, localPos: new THREE.Vector3(-0.3, 2.12, 0.0) }, 
        // 胸: 少し高く、体幹に近づける (Y: 1.4, Z: 0.15)
        chest: { pos: new THREE.Vector3(0, 0, 0), el: null, localPos: new THREE.Vector3(0, 1.8, 0.15) }, 
        // 袖: さらに先端へ移動、少し低く (X: 0.9, Y: 1.35)
        sleeve: { pos: new THREE.Vector3(0, 0, 0), el: null, localPos: new THREE.Vector3(0.8, 1.75, 0.0) } 
    };
    
    function disposeHierarchy (node) {
        for (var i = node.children.length - 1; i >= 0; i--) {
            var child = node.children[i];
            disposeHierarchy(child);
            scene.remove(child);
        }
        if (node.geometry) {
            node.geometry.dispose();
        }
        if (node.material) {
            if (node.material.length) {
                for (let i = 0; i < node.material.length; ++i) {
                    node.material[i].dispose();
                }
            } else {
                node.material.dispose();
            }
        }
    }

    function cleanup3DScene() {
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        if (scene) {
            disposeHierarchy(scene);
            scene = null;
        }
        if (renderer) {
            renderer.dispose();
            const container = document.getElementById('canvas-container');
            if (container && renderer.domElement) {
                 container.removeChild(renderer.domElement);
            }
            renderer = null;
        }
        if (controls) {
            controls.dispose();
            controls = null;
        }
        window.removeEventListener('resize', onWindowResize);
    }

    // フォールバック用の簡易マネキン作成関数
    function createFallbackMannequin() {
        const fallbackGroup = new THREE.Group();
        const mat = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.8 });
        const torso = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.3), mat);
        torso.position.y = 1.0;
        fallbackGroup.add(torso);
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.15, 16, 16), mat);
        head.position.y = 1.55;
        fallbackGroup.add(head);
        return fallbackGroup;
    }

    function init3DScene(result) {
        cleanup3DScene();
        
        try {
            const container = document.getElementById('canvas-container');
            
// init3DScene 関数内の container.innerHTML を以下に差し替え
container.innerHTML = `
    <div id="annotation-shoulder" class="annotation" style="display: none;"><span class="label text-[9px] text-gray-400 uppercase">Shoulder</span><span class="status font-bold"></span></div>
    <div id="annotation-chest" class="annotation" style="display: none;"><span class="label text-[9px] text-gray-400 uppercase">Chest</span><span class="status font-bold"></span></div>
    <div id="annotation-sleeve" class="annotation" style="display: none;"><span class="label text-[9px] text-gray-400 uppercase">Sleeve</span><span class="status font-bold"></span></div>
    
    <div id="scroll-indicator" class="absolute bottom-2 left-1/2 -translate-x-1/2 flex flex-col items-center animate-bounce text-slate-400 pointer-events-none z-30">
        <span class="text-[10px] font-bold uppercase tracking-widest mb-1">Scroll</span>
        <i class="fa-solid fa-chevron-down text-lg"></i>
    </div>

    <div class="absolute bottom-4 left-0 w-full text-center pointer-events-none">
        <p class="text-[10px] text-gray-400 bg-white/80 inline-block px-3 py-1 rounded-full backdrop-blur-sm">
            <i class="fa-solid fa-arrows-up-down-left-right mr-1"></i> 回転 / ズーム
        </p>
    </div>
`;
            renderResult(result);
            trackers.shoulder.el = document.getElementById('annotation-shoulder');
            trackers.chest.el = document.getElementById('annotation-chest');
            trackers.sleeve.el = document.getElementById('annotation-sleeve');

            // Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf1f5f9); 

            // Camera Setup
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
            // [修正] カメラ位置を少し離して全体が見えるように調整
            // [修正前]
// camera.position.set(0, 1.2, 4.5); 

// [修正後] 斜め45度から見下ろすアングル
          camera.position.set(0.25, 1.8, 0.1);

            // Renderer Setup
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            onWindowResize(); 

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
            dirLight.position.set(2, 5, 2);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // Floor plane
            const planeGeo = new THREE.PlaneGeometry(10, 10);
            const planeMat = new THREE.MeshStandardMaterial({ color: 0xdddddd });
            const plane = new THREE.Mesh(planeGeo, planeMat);
            plane.rotation.x = -Math.PI / 2;
            plane.receiveShadow = true;
            scene.add(plane);

            // GLB Loader
            const loader = new THREE.GLTFLoader();
            const modelPath = 'mannequin.glb'; 
            console.log(`Attempting to load model from: ${modelPath}`);

            loader.load(
                modelPath,
                (gltf) => {
                    console.log("Model loaded successfully!");
                    mannequin = gltf.scene;
                    
                    // [修正] スマホとPCでスケールを調整
                    const isMobile = window.innerWidth < 768;
                    // PCでは少し小さく(0.8)、スマホでは少し大きく表示(0.9)
                    const scale = isMobile ? 0.9 : 0.8;
                    mannequin.scale.set(scale, scale, scale);
                    
                    mannequin.position.y = 0; // 足元合わせ

                    mannequin.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });

                    scene.add(mannequin);
                    onModelReady(result);
                },
                undefined,
                (error) => {
                    console.error('GLBロードエラー。フォールバックを表示します。', error);
                    mannequin = createFallbackMannequin();
                    scene.add(mannequin);
                    // フォールバック用のアノテーション位置調整
                    trackers.shoulder.localPos.set(0.35, 1.3, 0);
                    trackers.chest.localPos.set(0, 1.0, 0.2);
                    trackers.sleeve.localPos.set(0.5, 1.0, 0);
                    onModelReady(result);
                }
            );

            // Controls Setup (ズーム有効化)
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            // [修正] ズームを有効化
            controls.enableZoom = true; 
            // [追加] ズーム範囲を制限 (寄りすぎ・離れすぎ防止)
            // --- ここから追加 ---
controls.autoRotate = true;          // 自動回転を有効化
controls.autoRotateSpeed = 2.0;      // 回転速度（デフォルトは2.0。1.0にするとよりゆっくりになります）
// ------------------
            controls.minDistance = 2.5;
            controls.maxDistance = 6.0;
            
            controls.minPolarAngle = Math.PI / 4; 
            controls.maxPolarAngle = Math.PI * 0.55; 
            controls.target.set(0, 1.0, 0); // 仮のターゲット

            window.addEventListener('resize', onWindowResize, false);

        } catch (error) {
            console.error("Three.js初期化エラー:", error);
            cleanup3DScene();
            const container = document.getElementById('canvas-container');
            container.innerHTML = `<div class="p-4 text-center text-red-500 font-bold">3Dモデルの表示に失敗しました。</div>`;
        }
    }

    function onModelReady(resultData) {
        addGarmentLayer(resultData);
        // カメラターゲットをモデルの中心付近に更新
        if (mannequin) {
             controls.target.set(0, 1.2, 0);
        }
        controls.update();
        if (!animationId) animate();
    }

    function addGarmentLayer(result) {
        if (!mannequin) return;

        const garmentColor = 0; 
        const garmentOpacity = 0; 
        // 1cm -> 0.0055 unit (約170cm=1.7 unitの比率)
        const scaleFactor = 0.0055; 
        // モデルのスケールに合わせて調整
        const modelScale = mannequin.scale.y;

        const garmentChest = result.spec.chest * scaleFactor * modelScale; 
        const garmentLength = result.spec.length * scaleFactor * modelScale; 
        // Tポーズなので肩幅は広めに設定
        const garmentShoulder = result.spec.shoulder * scaleFactor * modelScale * 2.0; 
        
        const garmentGeo = new THREE.BoxGeometry(garmentShoulder, garmentLength, garmentChest / 2.5); 
        const garmentMaterial = new THREE.MeshStandardMaterial({
            color: garmentColor,
            transparent: true,
            opacity: garmentOpacity,
            side: THREE.DoubleSide, 
            wireframe: false
        });
        
        const garment = new THREE.Mesh(garmentGeo, garmentMaterial);
        
        // Garmentの位置調整 (Tポーズモデルの胸の高さに合わせて調整)
        // モデルのYスケール1.0基準で、胸の高さが約1.3くらいの位置
        garment.position.y = (1.3 * modelScale); 
        garment.castShadow = false; 
        
        mannequin.add(garment);
        
        // 胸のアノテーション位置をガーメントの前面に合わせて微調整
        trackers.chest.localPos.z = (garmentChest / 5) + 0.15; 
    }

    function onWindowResize() {
        if (!camera || !renderer) return;
        const container = document.getElementById('canvas-container');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }
// 結果画面（result-view）をスクロールした時に矢印を消す処理
document.getElementById('result-view').addEventListener('scroll', function() {
    const indicator = document.getElementById('scroll-indicator');
    if (indicator && this.scrollTop > 20) {
        indicator.style.opacity = '0';
        indicator.style.transition = 'opacity 0.5s';
        setTimeout(() => indicator.style.display = 'none', 500);
    }
}, { passive: true });
    function animate() {
        if (!renderer) return;
        animationId = requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
        updateAnnotations();
    }

    function updateAnnotations() {
        if (!renderer || !camera || !mannequin) return;

        const width = renderer.domElement.clientWidth;
        const height = renderer.domElement.clientHeight;
        const widthHalf = width / 2;
        const heightHalf = height / 2;

        for (const key in trackers) {
            const t = trackers[key];
            if (!t.el || !t.localPos) continue;

            // Clone local position and apply mannequin's world matrix
            const pos = t.localPos.clone().applyMatrix4(mannequin.matrixWorld);
            
            // Project to 2D screen space
            pos.project(camera);

            const x = (pos.x * widthHalf) + widthHalf;
            const y = -(pos.y * heightHalf) + heightHalf;

            // Check if behind camera and within screen bounds (簡易判定)
            if (pos.z < 1 && x > 0 && x < width && y > 0 && y < height) {
                t.el.style.display = 'flex';
                t.el.style.left = `${x}px`;
                t.el.style.top = `${y}px`;
                
                // Fine-tune offset for better placement
                if (key === 'shoulder') t.el.style.top = `${y - 40}px`;
                if (key === 'sleeve') t.el.style.top = `${y - 40}px`;
            } else {
                t.el.style.display = 'none';
            }
        }
    }
    
    // Initial UI setup
    updateUI(1);

    // Initial sync of range sliders
    document.getElementById('height-range').oninput({ target: { value: 170 }});
    document.getElementById('weight-range').oninput({ target: { value: 60 }});
  </script>
</body>
</html>
